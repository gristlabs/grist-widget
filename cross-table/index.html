<!--
  Grist Cross-Table Explorer Widget
  Copyright 2026 Said Hamadou
  Licensed under the Apache License, Version 2.0
  https://github.com/isaytoo/grist-cross-table-widget
-->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cross-Table Explorer</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    /* ========== RESET & BASE ========== */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 13px;
      color: #1e293b;
      background: #f8fafc;
      padding: 12px;
      line-height: 1.5;
    }

    /* ========== HEADER ========== */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid #e2e8f0;
    }
    .header h1 {
      font-size: 18px;
      font-weight: 700;
      color: #0f172a;
    }
    .header h1 span { color: #3b82f6; }
    .lang-switch {
      display: flex;
      gap: 4px;
    }
    .lang-btn {
      padding: 4px 10px;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      background: #fff;
      cursor: pointer;
      font-size: 12px;
      color: #64748b;
      transition: all 0.2s;
    }
    .lang-btn.active {
      background: #3b82f6;
      color: #fff;
      border-color: #3b82f6;
    }

    /* ========== STEPS ========== */
    .step {
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 14px;
      position: relative;
    }
    .step-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }
    .step-number {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #3b82f6;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      flex-shrink: 0;
    }
    .step-title {
      font-size: 15px;
      font-weight: 600;
      color: #0f172a;
    }
    .step-desc {
      font-size: 12px;
      color: #64748b;
      margin-bottom: 12px;
    }

    /* ========== FORM ELEMENTS ========== */
    select, input[type="text"] {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      font-size: 13px;
      color: #1e293b;
      background: #fff;
      transition: border-color 0.2s;
    }
    select:focus, input[type="text"]:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: #475569;
      margin-bottom: 4px;
    }
    .form-group { margin-bottom: 10px; }

    /* ========== BUTTONS ========== */
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: #3b82f6; color: #fff; }
    .btn-primary:hover:not(:disabled) { background: #2563eb; }
    .btn-success { background: #10b981; color: #fff; }
    .btn-success:hover:not(:disabled) { background: #059669; }
    .btn-danger { background: #ef4444; color: #fff; }
    .btn-danger:hover:not(:disabled) { background: #dc2626; }
    .btn-secondary { background: #f1f5f9; color: #475569; border: 1px solid #cbd5e1; }
    .btn-secondary:hover:not(:disabled) { background: #e2e8f0; }
    .btn-sm { padding: 4px 10px; font-size: 12px; }
    .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }

    /* ========== TABLE SELECTOR ========== */
    .table-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }
    .table-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid #e2e8f0;
      background: #fff;
      color: #475569;
    }
    .table-chip:hover { border-color: #3b82f6; }
    .table-chip.selected {
      background: #eff6ff;
      border-color: #3b82f6;
      color: #1d4ed8;
    }
    .table-chip .remove {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #dc2626;
      color: #fff;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      cursor: pointer;
    }
    .table-chip.selected .remove { display: flex; }

    /* ========== KEY MAPPING ========== */
    .key-mapping {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
    }
    .key-mapping-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .key-mapping-row:last-child { margin-bottom: 0; }
    .key-mapping-label {
      min-width: 120px;
      font-size: 12px;
      font-weight: 600;
      color: #3b82f6;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .key-mapping-select { flex: 1; }

    /* ========== COLUMN PICKER ========== */
    .col-picker {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      max-height: 200px;
      overflow-y: auto;
      padding: 8px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
    }
    .col-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 14px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.15s;
      border: 1px solid #e2e8f0;
      background: #fff;
      color: #64748b;
    }
    .col-chip:hover { border-color: #3b82f6; }
    .col-chip.selected {
      background: #dbeafe;
      border-color: #3b82f6;
      color: #1d4ed8;
    }
    .col-chip .table-tag {
      font-size: 9px;
      background: #e2e8f0;
      padding: 1px 5px;
      border-radius: 8px;
      color: #64748b;
    }
    .col-chip.selected .table-tag {
      background: #bfdbfe;
      color: #1d4ed8;
    }

    /* ========== FILTERS ========== */
    .filter-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      background: #f8fafc;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }
    .filter-row select { width: auto; flex: 1; }
    .filter-row input { flex: 1; }
    .filter-remove {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: none;
      background: #fee2e2;
      color: #dc2626;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }

    /* ========== RESULTS TABLE ========== */
    .results-container {
      overflow-x: auto;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      background: #fff;
      max-height: 500px;
      overflow-y: auto;
    }
    .results-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    .results-table th {
      background: #f1f5f9;
      padding: 8px 12px;
      text-align: left;
      font-weight: 600;
      color: #475569;
      border-bottom: 2px solid #e2e8f0;
      position: sticky;
      top: 0;
      z-index: 1;
      white-space: nowrap;
      cursor: pointer;
      user-select: none;
    }
    .results-table th:hover { background: #e2e8f0; }
    .results-table th .sort-icon { font-size: 10px; margin-left: 4px; }
    .results-table td {
      padding: 6px 12px;
      border-bottom: 1px solid #f1f5f9;
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .results-table tr:hover td { background: #f8fafc; }
    .results-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 12px;
      color: #64748b;
    }
    .results-count { font-weight: 600; color: #3b82f6; }

    /* ========== GENERATE TABLE ========== */
    .generate-section {
      background: #f0fdf4;
      border: 2px solid #bbf7d0;
      border-radius: 12px;
      padding: 16px;
      margin-top: 14px;
    }
    .generate-section h3 {
      font-size: 14px;
      font-weight: 700;
      color: #166534;
      margin-bottom: 8px;
    }
    .generate-row {
      display: flex;
      align-items: end;
      gap: 10px;
    }
    .generate-row .form-group { flex: 1; margin-bottom: 0; }

    /* ========== JOIN TYPE ========== */
    .join-type-selector {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .join-type-btn {
      padding: 6px 14px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      background: #fff;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      color: #64748b;
      transition: all 0.2s;
    }
    .join-type-btn.active {
      border-color: #3b82f6;
      background: #eff6ff;
      color: #1d4ed8;
    }
    .join-type-btn:hover { border-color: #93c5fd; }

    /* ========== MESSAGES ========== */
    .message {
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 12px;
      margin-bottom: 10px;
    }
    .message-info { background: #eff6ff; color: #1d4ed8; border: 1px solid #bfdbfe; }
    .message-success { background: #f0fdf4; color: #166534; border: 1px solid #bbf7d0; }
    .message-error { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }
    .message-warning { background: #fffbeb; color: #92400e; border: 1px solid #fde68a; }

    /* ========== TOAST ========== */
    .toast-container {
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .toast {
      padding: 12px 20px;
      border-radius: 10px;
      color: #fff;
      font-size: 13px;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      animation: toastIn 0.3s ease;
      max-width: 320px;
    }
    .toast-success { background: #10b981; }
    .toast-error { background: #ef4444; }
    .toast-info { background: #3b82f6; }
    @keyframes toastIn {
      from { opacity: 0; transform: translateX(40px); }
      to { opacity: 1; transform: translateX(0); }
    }

    /* ========== LOADING ========== */
    .loading {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #64748b;
      font-size: 13px;
      padding: 20px 0;
    }
    .spinner {
      width: 20px;
      height: 20px;
      border: 3px solid #e2e8f0;
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .hidden { display: none !important; }

    /* ========== EMPTY STATE ========== */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #94a3b8;
    }
    .empty-state .icon { font-size: 40px; margin-bottom: 10px; }
    .empty-state p { font-size: 13px; }

    /* ========== FOOTER ========== */
    .footer {
      text-align: center;
      padding: 12px 0;
      color: #94a3b8;
      font-size: 11px;
      border-top: 1px solid #e2e8f0;
      margin-top: 16px;
    }

    /* ========== MODAL ========== */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.4);
      z-index: 9000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      max-width: 420px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    }
    .modal h3 { font-size: 16px; font-weight: 700; margin-bottom: 12px; color: #0f172a; }
    .modal p { font-size: 13px; color: #475569; margin-bottom: 16px; }
    .modal .btn-group { justify-content: flex-end; }

    /* ========== SCROLLBAR ========== */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 3px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* ========== SELECT ALL ========== */
    .select-all-row {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 6px;
    }
    .select-all-btn {
      font-size: 11px;
      color: #3b82f6;
      cursor: pointer;
      background: none;
      border: none;
      font-weight: 600;
    }
    .select-all-btn:hover { text-decoration: underline; }
  </style>
</head>
<body>

  <!-- HEADER -->
  <div class="header">
    <h1>üîÄ <span data-i18n="title">Cross-Table Explorer</span></h1>
    <div class="lang-switch">
      <button class="lang-btn active" onclick="setLang('fr')">FR</button>
      <button class="lang-btn" onclick="setLang('en')">EN</button>
    </div>
  </div>

  <!-- NOT IN GRIST MESSAGE -->
  <div id="not-in-grist" class="hidden">
    <div class="empty-state">
      <div class="icon">‚ö†Ô∏è</div>
      <p data-i18n="notInGrist">Ce widget doit √™tre utilis√© dans Grist.</p>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div id="main-content">

    <!-- STEP 1: SELECT TABLES -->
    <div class="step">
      <div class="step-header">
        <div class="step-number">1</div>
        <div class="step-title" data-i18n="step1Title">S√©lectionner les tables</div>
      </div>
      <div class="step-desc" data-i18n="step1Desc">Cliquez sur les tables que vous souhaitez croiser (minimum 2).</div>
      <div id="tables-loading" class="loading hidden">
        <div class="spinner"></div>
        <span data-i18n="loading">Chargement...</span>
      </div>
      <div id="table-chips" class="table-selector"></div>
      <div id="tables-empty" class="hidden">
        <div class="message message-warning" data-i18n="noTables">Aucune table trouv√©e dans le document.</div>
      </div>
    </div>

    <!-- STEP 2: MAP KEYS -->
    <div class="step hidden" id="step-keys">
      <div class="step-header">
        <div class="step-number">2</div>
        <div class="step-title" data-i18n="step2Title">Mapper la cl√© commune</div>
      </div>
      <div class="step-desc" data-i18n="step2Desc">S√©lectionnez la colonne cl√© (ID) dans chaque table pour la jointure.</div>
      <div id="key-mappings"></div>
      <div style="margin-top: 10px;">
        <label data-i18n="joinTypeLabel">Type de jointure :</label>
        <div class="join-type-selector" id="join-type-selector">
          <button class="join-type-btn active" data-type="inner" onclick="setJoinType('inner')">
            INNER <span style="font-weight:400; font-size:11px;" data-i18n="joinInnerDesc">(correspondances uniquement)</span>
          </button>
          <button class="join-type-btn" data-type="left" onclick="setJoinType('left')">
            LEFT <span style="font-weight:400; font-size:11px;" data-i18n="joinLeftDesc">(tout de la 1√®re table)</span>
          </button>
        </div>
        <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px 14px; margin-top: 8px; font-size: 11px; color: #64748b; line-height: 1.6;">
          üí° <strong>INNER</strong> <span data-i18n="joinInnerHelp">= uniquement les lignes qui ont une correspondance dans toutes les tables.</span><br/>
          üí° <strong>LEFT</strong> <span data-i18n="joinLeftHelp">= toutes les lignes de la 1√®re table, m√™me sans correspondance (colonnes vides si pas de match).</span><br/>
          <span data-i18n="joinOrderHint">‚ö†Ô∏è En mode LEFT, la 1√®re table s√©lectionn√©e (en vert) est la table principale. Toutes ses lignes seront conserv√©es.</span>
        </div>
      </div>
    </div>

    <!-- STEP 3: SELECT COLUMNS -->
    <div class="step hidden" id="step-columns">
      <div class="step-header">
        <div class="step-number">3</div>
        <div class="step-title" data-i18n="step3Title">Choisir les colonnes</div>
      </div>
      <div class="step-desc" data-i18n="step3Desc">S√©lectionnez les colonnes √† afficher dans le r√©sultat.</div>
      <div class="select-all-row">
        <button class="select-all-btn" id="select-all-cols" onclick="toggleAllColumns()">
          <span data-i18n="selectAll">‚úì Tout s√©lectionner</span>
        </button>
      </div>
      <div id="col-picker" class="col-picker"></div>
    </div>

    <!-- STEP 4: FILTERS -->
    <div class="step hidden" id="step-filters">
      <div class="step-header">
        <div class="step-number">4</div>
        <div class="step-title" data-i18n="step4Title">Filtres</div>
      </div>
      <div class="step-desc" data-i18n="step4Desc">Ajoutez des filtres pour affiner les r√©sultats (optionnel).</div>
      <div id="filters-container"></div>
      <div style="margin-top: 8px; display: flex; align-items: center; gap: 16px;">
        <button class="btn btn-secondary btn-sm" id="add-filter-btn" onclick="addFilter()">
          ‚ûï <span data-i18n="addFilter">Ajouter un filtre</span>
        </button>
        <label style="display: flex; align-items: center; gap: 6px; font-size: 12px; cursor: pointer;">
          <input type="checkbox" id="deduplicate-check" checked />
          <span data-i18n="deduplicateLabel">üßπ Supprimer les doublons</span>
        </label>
      </div>
    </div>

    <!-- EXECUTE -->
    <div class="step hidden" id="step-execute">
      <div class="btn-group" style="justify-content: center;">
        <button class="btn btn-primary" id="execute-btn" onclick="executeJoin()" style="font-size: 14px; padding: 10px 28px;">
          üîÄ <span data-i18n="executeJoin">Croiser les donn√©es</span>
        </button>
        <button class="btn btn-danger" onclick="resetAll()" style="font-size: 14px; padding: 10px 28px;">
          üîÑ <span data-i18n="newQuery">Nouvelle requ√™te</span>
        </button>
      </div>
    </div>

    <!-- RESULTS -->
    <div class="step hidden" id="step-results">
      <div class="step-header">
        <div class="step-number">‚úì</div>
        <div class="step-title" data-i18n="resultsTitle">R√©sultats</div>
      </div>
      <div id="results-info" class="results-info"></div>
      <div id="results-container" class="results-container"></div>

      <!-- GENERATE TABLE -->
      <div class="generate-section" id="generate-section">
        <h3>üì• <span data-i18n="generateTitle">G√©n√©rer une table dans Grist</span></h3>
        <p style="font-size: 12px; color: #166534; margin-bottom: 12px;" data-i18n="generateDesc">
          Cr√©ez une nouvelle table dans votre document avec les donn√©es crois√©es.
        </p>
        <div class="generate-row">
          <div class="form-group">
            <label data-i18n="tableNameLabel">Nom de la table :</label>
            <input type="text" id="generate-table-name" placeholder="Resultat_Croise" />
          </div>
          <button class="btn btn-success" id="generate-btn" onclick="generateTable()">
            üì• <span data-i18n="generateBtn">Cr√©er la table</span>
          </button>
          <button class="btn btn-primary hidden" id="refresh-btn" onclick="refreshTable()">
            üîÑ <span data-i18n="refreshBtn">Rafra√Æchir</span>
          </button>
        </div>
        <div id="generate-message" class="hidden" style="margin-top: 10px;"></div>
      </div>
    </div>

  </div>

  <!-- TOAST CONTAINER -->
  <div class="toast-container" id="toast-container"></div>

  <!-- MODAL -->
  <div class="modal-overlay hidden" id="modal-overlay">
    <div class="modal">
      <h3 id="modal-title"></h3>
      <p id="modal-body"></p>
      <div class="btn-group">
        <button class="btn btn-secondary" id="modal-cancel" onclick="closeModal()">
          <span data-i18n="cancel">Annuler</span>
        </button>
        <button class="btn btn-primary" id="modal-confirm">
          <span data-i18n="confirm">Confirmer</span>
        </button>
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <div class="footer">
    <span data-i18n="footerCreated">Cr√©√© par</span> <strong>Said Hamadou (HmD)</strong> &mdash; 2026
  </div>

  <script src="widget.js"></script>
</body>
</html>
